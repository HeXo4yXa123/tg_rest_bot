<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Restaurant Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body {
      margin: 0;
      padding: 20px;
      background: #0f0f0f;
      color: #e6e6e6;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }

    h1 {
      color: #00ff88;
      font-size: 22px;
      margin-bottom: 20px;
    }

    button {
      width: 100%;
      padding: 16px;
      background: #00ff88;
      color: #000;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
    }

    button:active {
      opacity: 0.8;
    }

    .box {
      margin-top: 20px;
      padding: 14px;
      background: #1a1a1a;
      border-radius: 12px;
      font-size: 14px;
      white-space: pre-wrap;
    }

    .muted {
      color: #777;
      font-size: 12px;
      margin-top: 10px;
    }
  </style>
</head>

<body>

<h1>üçî –°–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑</h1>

<button id="orderBtn">–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</button>

<div id="result" class="box">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</div>

<p class="muted">Demo Mini App</p>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const tg = window.Telegram.WebApp;
  tg.ready();

  // üîß –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ó–ê–ú–ï–ù–ò
  const SUPABASE_URL = "https://urpxgkdzvzvxvykhusxo.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVycHhna2R6dnp2eHZ5a2h1c3hvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NTM1MjgsImV4cCI6MjA4MTIyOTUyOH0.i5qMCpsWx6E6YbxCEUZ8r0L90MHshJoMsOe55JZsAE0";

  const result = document.getElementById("result");
  const btn = document.getElementById("orderBtn");

  btn.onclick = async () => {
    try {
      result.textContent = "–°–æ–∑–¥–∞—ë–º –∑–∞–∫–∞–∑...";

      const telegramId = tg.initDataUnsafe.user.id;

      // 1. –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const userRes = await fetch(
        `${SUPABASE_URL}/rest/v1/users?telegram_id=eq.${telegramId}`,
        {
          headers: {
            apikey: SUPABASE_KEY,
            Authorization: `Bearer ${SUPABASE_KEY}`
          }
        }
      );

      const users = await userRes.json();

      if (!users.length) {
        result.textContent = "‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω";
        return;
      }

      const user = users[0];

      // 2. –°–æ–∑–¥–∞—ë–º –∑–∞–∫–∞–∑
      const orderRes = await fetch(
        `${SUPABASE_URL}/rest/v1/orders`,
        {
          method: "POST",
          headers: {
            apikey: SUPABASE_KEY,
            Authorization: `Bearer ${SUPABASE_KEY}`,
            "Content-Type": "application/json",
            Prefer: "return=representation"
          },
          body: JSON.stringify({
            user_id: user.id,
            branch_id: user.branch_id,
            status: "new",
            total_price: 500
          })
        }
      );

      const order = await orderRes.json();

      result.textContent =
        "‚úÖ –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω\n\nID:\n" + order[0].id;

    } catch (e) {
      result.textContent = "–û—à–∏–±–∫–∞:\n" + e;
    }
  };

});
</script>

</body>
</html>
