<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Mini App MVP</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
body { font-family: 'Segoe UI', sans-serif; margin:0; padding:20px; background:#0f0f0f; color:#eee; }
h2 { color:#00ff88; margin-bottom:20px; }
#roleBtn {
  position:absolute; top:20px; right:20px;
  background:#00ff88; color:#000;
  border:none; border-radius:16px; padding:10px 16px; cursor:pointer; font-weight:bold;
}
#roleMenu { display:none; position:absolute; top:60px; right:20px; background:#222; border-radius:12px; padding:10px; }
#roleMenu button { display:block; width:100%; margin-bottom:5px; padding:8px; border:none; border-radius:10px; background:#111; color:#00ff88; font-weight:bold; cursor:pointer; }
#roleMenu button:hover { background:#00ff88; color:#000; }

button.client, button.manager, button.courier {
  border:none; border-radius:12px; padding:10px 16px; cursor:pointer; font-weight:bold; margin:4px;
}
button.client { background:#00ff88; color:#000; }
button.manager { background:#ffcc00; color:#000; }
button.courier { background:#00ccff; color:#000; }

.orderCard { background:#1a1a1a; padding:12px; border-radius:12px; margin-bottom:12px; }
#log { background:#222; padding:12px; border-radius:12px; margin-top:20px; white-space:pre-wrap; }
.selectStatus { margin-left:10px; padding:5px; border-radius:8px; background:#111; color:#00ff88; border:none; }
</style>
</head>
<body>

<h2>Mini App: –∫–ª–∏–µ–Ω—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä-–∫—É—Ä—å–µ—Ä</h2>

<button id="roleBtn">üë§ –†–æ–ª—å</button>
<div id="roleMenu">
  <button data-role="client">–Ø –∫–ª–∏–µ–Ω—Ç</button>
  <button data-role="manager">–Ø –º–µ–Ω–µ–¥–∂–µ—Ä</button>
  <button data-role="courier">–Ø –∫—É—Ä—å–µ—Ä</button>
</div>

<div id="interface"></div>
<div id="log">–õ–æ–≥ –¥–µ–π—Å—Ç–≤–∏–π</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const tg = window.Telegram.WebApp;
  tg.ready();

  const SUPABASE_URL = "https://urpxgkdzvzvxvykhusxo.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVycHhna2R6dnp2eHZ5a2h1c3hvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NTM1MjgsImV4cCI6MjA4MTIyOTUyOH0.i5qMCpsWx6E6YbxCEUZ8r0L90MHshJoMsOe55JZsAE0";

  const roleBtn = document.getElementById("roleBtn");
  const roleMenu = document.getElementById("roleMenu");
  const iface = document.getElementById("interface");
  const log = document.getElementById("log");

  let currentRole = "client";

  roleBtn.onclick = () => { roleMenu.style.display = roleMenu.style.display === "block" ? "none" : "block"; };
  roleMenu.querySelectorAll("button").forEach(btn => {
    btn.onclick = () => { currentRole = btn.dataset.role; roleMenu.style.display = "none"; log.textContent=`–í—ã –≤—ã–±—Ä–∞–ª–∏ —Ä–æ–ª—å: ${currentRole}`; renderInterface(); };
  });

  async function fetchOrders(filter="") {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/orders?${filter}&order=created_at.asc`, {
      headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` }
    });
    return await res.json();
  }

  async function renderInterface() {
    iface.innerHTML="";

    if(currentRole==="client"){
      const btn = document.createElement("button");
      btn.textContent="–°–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑";
      btn.className="client";
      btn.onclick=async ()=>{
        try{
          const telegramId = tg.initDataUnsafe.user.id;
          const userRes = await fetch(`${SUPABASE_URL}/rest/v1/users?telegram_id=eq.${telegramId}`, {
            headers:{apikey:SUPABASE_KEY,Authorization:`Bearer ${SUPABASE_KEY}`}
          });
          const users = await userRes.json();
          if(!users.length){ log.textContent="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω"; return; }
          const user=users[0];

          const orderRes = await fetch(`${SUPABASE_URL}/rest/v1/orders`,{
            method:"POST",
            headers:{apikey:SUPABASE_KEY,Authorization:`Bearer ${SUPABASE_KEY}`,"Content-Type":"application/json",Prefer:"return=representation"},
            body:JSON.stringify({user_id:user.id,branch_id:user.branch_id,status:"new",total_price:500})
          });
          const order = await orderRes.json();
          log.textContent=`–ö–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–ª –∑–∞–∫–∞–∑ ${order[0].id}`;
          renderInterface();
        }catch(e){ log.textContent="–û—à–∏–±–∫–∞: "+e; }
      };
      iface.appendChild(btn);
    }

    else if(currentRole==="manager"){
      const orders = await fetchOrders();
      if(!orders.length){ iface.textContent="–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤"; return; }

      orders.forEach(order=>{
        const div=document.createElement("div");
        div.className="orderCard";
        div.innerHTML=`<b>–ó–∞–∫–∞–∑ ${order.id}</b> | –°—Ç–∞—Ç—É—Å: ${order.status}`;

        const select = document.createElement("select");
        select.className="selectStatus";
        ["new","accepted","cooking","ready","delivering","delivered"].forEach(s=>{
          const opt=document.createElement("option"); opt.value=s; opt.text=s; if(s===order.status) opt.selected=true; select.appendChild(opt);
        });
        select.onchange=async ()=>{
          await fetch(`${SUPABASE_URL}/rest/v1/orders?id=eq.${order.id}`,{
            method:"PATCH",
            headers:{apikey:SUPABASE_KEY,Authorization:`Bearer ${SUPABASE_KEY}`,"Content-Type":"application/json"},
            body:JSON.stringify({status:select.value})
          });
          log.textContent=`–ú–µ–Ω–µ–¥–∂–µ—Ä –∏–∑–º–µ–Ω–∏–ª –∑–∞–∫–∞–∑ ${order.id} –Ω–∞ —Å—Ç–∞—Ç—É—Å ${select.value}`;
          renderInterface();
        };
        div.appendChild(select);

        const btnCourier = document.createElement("button");
        btnCourier.textContent="–ü–µ—Ä–µ–¥–∞—Ç—å –∫—É—Ä—å–µ—Ä—É";
        btnCourier.className="manager";
        btnCourier.onclick=async ()=>{
          await fetch(`${SUPABASE_URL}/rest/v1/orders?id=eq.${order.id}`,{
            method:"PATCH",
            headers:{apikey:SUPABASE_KEY,Authorization:`Bearer ${SUPABASE_KEY}`,"Content-Type":"application/json"},
            body:JSON.stringify({status:"accepted"})
          });
          log.textContent=`–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–µ—Ä–µ–¥–∞–ª –∑–∞–∫–∞–∑ ${order.id} –∫—É—Ä—å–µ—Ä—É`;
          renderInterface();
        };
        div.appendChild(btnCourier);
        iface.appendChild(div);
      });
    }

    else if(currentRole==="courier"){
      const orders = await fetchOrders("status=eq.accepted");
      if(!orders.length){ iface.textContent="–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏"; return; }

      orders.forEach(order=>{
        const div=document.createElement("div");
        div.className="orderCard";
        div.innerHTML=`<b>–ó–∞–∫–∞–∑ ${order.id}</b> | –°—Ç–∞—Ç—É—Å: ${order.status}<br>–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–µ—Ä–µ–¥–∞–ª –∑–∞–∫–∞–∑`;

        const btnAccept=document.createElement("button");
        btnAccept.className="courier";
        btnAccept.textContent="–ü—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑";
        btnAccept.onclick=()=>{
          btnAccept.textContent="–°–¥–∞—Ç—å –∑–∞–∫–∞–∑";
          log.textContent=`–ö—É—Ä—å–µ—Ä –ø—Ä–∏–Ω—è–ª –∑–∞–∫–∞–∑ ${order.id}`;
          btnAccept.onclick=async ()=>{
            await fetch(`${SUPABASE_URL}/rest/v1/orders?id=eq.${order.id}`,{
              method:"DELETE",
              headers:{apikey:SUPABASE_KEY,Authorization:`Bearer ${SUPABASE_KEY}`}
            });
            log.textContent=`–ö—É—Ä—å–µ—Ä —Å–¥–∞–ª –∑–∞–∫–∞–∑ ${order.id} ‚Äî –∑–∞–∫–∞–∑ —É–¥–∞–ª—ë–Ω –∏–∑ –±–∞–∑—ã`;
            renderInterface();
          };
        };
        div.appendChild(btnAccept);
        iface.appendChild(div);
      });
    }
  }

  renderInterface();
});
</script>

</body>
</html>
