<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Mini App</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
:root{
  --bg-main:#0A0A09;
  --bg-surface:#191917;
  --accent:#21EA7C;
  --text:#fff;
  --muted:#7a7a7a;
}

*{box-sizing:border-box}

body{
  margin:0;
  padding:16px;
  padding-bottom:110px;
  background:var(--bg-main);
  font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
  color:var(--text);
}

/* TYPO */
h1{
  font-size:26px;
  margin:8px 0 16px;
}
h2{margin:0;font-size:18px}

/* CARD */
.card{
  background:var(--bg-surface);
  border-radius:18px;
  padding:16px;
  margin-bottom:12px;
}

/* BUTTON */
button{
  width:100%;
  padding:14px;
  border:none;
  border-radius:16px;
  font-weight:600;
  background:var(--accent);
  color:#000;
}

/* EMPTY */
.empty{
  text-align:center;
  margin-top:40px;
}
.empty-icon{
  width:120px;
  height:120px;
  margin:0 auto 16px;
  border-radius:28px;
  background:#1f1f1c;
  display:flex;
  align-items:center;
  justify-content:center;
}

/* PROFILE */
.profile-head{
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.profile-left{
  display:flex;
  gap:12px;
  align-items:center;
}

.avatar{
  width:48px;
  height:48px;
  border-radius:50%;
  background:#c77dff;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
}

.arrow{color:var(--accent);font-size:20px}

/* LIST */
.list{
  list-style:none;
  padding:0;
  margin:0;
}
.list li{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px 0;
  border-bottom:1px solid #2a2a2a;
}
.list li:last-child{border-bottom:none}

.list-left{
  display:flex;
  gap:10px;
  align-items:center;
}
.icon{color:var(--accent)}

/* BOTTOM NAV */
.bottom-nav{
  position:fixed;
  bottom:12px;
  left:12px;
  right:12px;
  background:var(--bg-surface);
  border-radius:26px;
  padding:10px 6px;
  display:flex;
}

.nav-item{
  flex:1;
  text-align:center;
  font-size:11px;
  color:var(--muted);
}
.nav-item.active{color:var(--accent)}
</style>
</head>

<body>

<div id="content"></div>

<!-- BOTTOM NAV -->
<div class="bottom-nav">
  <div class="nav-item active" data-tab="home">–ì–ª–∞–≤–Ω–∞—è</div>
  <div class="nav-item" data-tab="cart">–ö–æ—Ä–∑–∏–Ω–∞</div>
  <div class="nav-item" data-tab="profile">–ü—Ä–æ—Ñ–∏–ª—å</div>
</div>

<script>
const tg=window.Telegram.WebApp;
tg.ready();

/* SUPABASE */
const SUPABASE_URL="https://urpxgkdzvzvxvykhusxo.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVycHhna2R6dnp2eHZ5a2h1c3hvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NTM1MjgsImV4cCI6MjA4MTIyOTUyOH0.i5qMCpsWx6E6YbxCEUZ8r0L90MHshJoMsOe55JZsAE0";

/* STATE */
let role=localStorage.getItem("role")||"client";
let lang=localStorage.getItem("lang")||"ru";
const user=tg.initDataUnsafe?.user;
const content=document.getElementById("content");

/* TEXT */
const txt={
  ru:{
    home:"–ì–ª–∞–≤–Ω–∞—è",
    cart:"–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞",
    order:"–°–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑",
    language:"–Ø–∑—ã–∫",
    empty:"–ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç"
  },
  en:{
    home:"Home",
    cart:"Cart is empty",
    order:"Make order",
    language:"Language",
    empty:"Nothing here yet"
  }
};

/* RESTAURANTS */
const restaurants=[
  "BBQ Garden",
  "Cafe LaiLa",
  "Cafe Ushba",
  "–î–æ–º –ö—É–¥–±–∞—Ä–∏",
  "Sunset Restaurant"
];

/* NAV */
document.querySelectorAll(".nav-item").forEach(i=>{
  i.onclick=()=>{
    document.querySelectorAll(".nav-item").forEach(n=>n.classList.remove("active"));
    i.classList.add("active");
    render(i.dataset.tab);
  };
});

/* USER INIT */
if(user){
  fetch(`${SUPABASE_URL}/rest/v1/users`,{
    method:"POST",
    headers:{
      apikey:SUPABASE_KEY,
      Authorization:`Bearer ${SUPABASE_KEY}`,
      "Content-Type":"application/json",
      Prefer:"resolution=ignore-duplicates"
    },
    body:JSON.stringify({
      telegram_id:user.id,
      role,
      language:lang
    })
  });
}

/* RENDER */
function render(tab){
  if(tab==="home"){
    content.innerHTML=`<h1>${txt[lang].home}</h1>`+
      restaurants.map(r=>`
        <div class="card">
          <h2>${r}</h2>
          <p class="muted">${txt[lang].empty}</p>
        </div>`).join("");
  }

  if(tab==="cart"){
    content.innerHTML=`
      <div class="empty">
        <div class="empty-icon"></div>
        <p>${txt[lang].cart}</p>
        <button onclick="createOrder()">${txt[lang].order}</button>
      </div>`;
  }

  if(tab==="profile"){
    content.innerHTML=`
      <div class="card">
        <div class="profile-head">
          <div class="profile-left">
            <div class="avatar">${user?.first_name?.[0]||"U"}</div>
            <div>
              <b>${user?.first_name||"User"}</b><br>
              <span class="muted">ID ${user?.id||""}</span>
            </div>
          </div>
          <span class="arrow" onclick="toggleRole()">‚Ä∫</span>
        </div>
        <div id="roles" style="display:none;margin-top:12px">
          <button onclick="setRole('client')">Client</button>
          <button onclick="setRole('manager')">Manager</button>
          <button onclick="setRole('courier')">Courier</button>
        </div>
      </div>

      <div class="card">
        <ul class="list">
          <li>
            <div class="list-left"><span class="icon">üåê</span>${txt[lang].language}</div>
            <span class="arrow" onclick="toggleLang()">‚Ä∫</span>
          </li>
        </ul>
      </div>`;
  }
}

/* ACTIONS */
function setRole(r){
  role=r;
  localStorage.setItem("role",r);
  render("profile");
}

function toggleRole(){
  const r=document.getElementById("roles");
  r.style.display=r.style.display==="block"?"none":"block";
}

function toggleLang(){
  lang=lang==="ru"?"en":"ru";
  localStorage.setItem("lang",lang);
  render("profile");
}

async function createOrder(){
  await fetch(`${SUPABASE_URL}/rest/v1/orders`,{
    method:"POST",
    headers:{
      apikey:SUPABASE_KEY,
      Authorization:`Bearer ${SUPABASE_KEY}`,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({
      status:"new",
      telegram_id:user.id
    })
  });
  alert("OK");
}

/* INIT */
render("home");
</script>

</body>
</html>
