<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Mini App</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
:root{
  --bg:#0A0A09;
  --card:#191917;
  --accent:#21EA7C;
  --text:#fff;
  --muted:#8a8a8a;
}

*{box-sizing:border-box}

body{
  margin:0;
  padding:16px;
  padding-bottom:110px;
  background:var(--bg);
  font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
  color:var(--text);
}

h1{font-size:26px;margin:12px 0 16px}

.card{
  background:var(--card);
  border-radius:18px;
  padding:16px;
  margin-bottom:12px;
}

.center{text-align:center}
.muted{color:var(--muted)}

button{
  width:100%;
  padding:14px;
  border:none;
  border-radius:16px;
  font-weight:600;
  background:var(--accent);
  color:#000;
}

/* EMPTY */
.empty-icon{
  width:120px;
  height:120px;
  border-radius:24px;
  background:linear-gradient(145deg,#1f1f1c,#141412);
  margin:32px auto 16px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:48px;
}

/* PROFILE */
.profile-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
}

.profile-left{
  display:flex;
  gap:12px;
  align-items:center;
}

.avatar{
  width:48px;
  height:48px;
  border-radius:50%;
  background:#c77dff;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
}

.role-toggle{
  color:var(--accent);
  font-size:20px;
  cursor:pointer;
}

.role-select{display:none;margin-top:12px}

.list{list-style:none;padding:0;margin:0}

.list li{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px 0;
  border-bottom:1px solid #2a2a2a;
}

.list li:last-child{border-bottom:none}

.arrow{color:var(--accent)}

/* BOTTOM NAV */
.bottom-nav{
  position:fixed;
  bottom:12px;
  left:12px;
  right:12px;
  background:var(--card);
  border-radius:24px;
  padding:10px 6px;
  display:flex;
  justify-content:space-around;
}

.nav-item{
  flex:1;
  text-align:center;
  font-size:11px;
  color:var(--muted);
}

.nav-item.active{color:var(--accent)}

.nav-item svg{
  width:22px;
  height:22px;
  display:block;
  margin:0 auto 4px;
  stroke:currentColor;
}
</style>
</head>

<body>

<div id="content"></div>

<div class="bottom-nav">
  <div class="nav-item active" data-tab="home">üè†<br>–ì–ª–∞–≤–Ω–∞—è</div>
  <div class="nav-item" data-tab="cart">üõí<br>–ö–æ—Ä–∑–∏–Ω–∞</div>
  <div class="nav-item" data-tab="profile">üë§<br>–ü—Ä–æ—Ñ–∏–ª—å</div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.ready();

const SUPABASE_URL="https://urpxgkdzvzvxvykhusxo.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVycHhna2R6dnp2eHZ5a2h1c3hvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NTM1MjgsImV4cCI6MjA4MTIyOTUyOH0.i5qMCpsWx6E6YbxCEUZ8r0L90MHshJoMsOe55JZsAE0";

const content=document.getElementById("content");
const nav=document.querySelectorAll(".nav-item");

let role = localStorage.getItem("role") || "client";
const user = tg.initDataUnsafe.user;

/* NAV */
nav.forEach(i=>{
  i.onclick=()=>{
    nav.forEach(n=>n.classList.remove("active"));
    i.classList.add("active");
    render(i.dataset.tab);
  }
});

/* RENDER */
function render(tab){
  if(tab==="home"){
    content.innerHTML=`<h1>–ì–ª–∞–≤–Ω–∞—è</h1><div class="card center muted">–ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç</div>`;
  }

  if(tab==="cart"){
    content.innerHTML=`
      <div class="empty-icon">üõçÔ∏è</div>
      <div class="center">
        <h2>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</h2>
        <button onclick="createOrder()">–°–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑</button>
      </div>
    `;
  }

  if(tab==="profile"){
    content.innerHTML=`
      <div class="card">
        <div class="profile-header">
          <div class="profile-left">
            <div class="avatar">${user.first_name[0]}</div>
            <div>
              <b>${user.first_name}</b><br>
              <span class="muted">ID ${user.id}</span>
            </div>
          </div>
          <div class="role-toggle" onclick="toggleRole()">‚åÑ</div>
        </div>

        <div class="role-select" id="roles">
          <button onclick="setRole('client')">–ö–ª–∏–µ–Ω—Ç</button>
          <button onclick="setRole('manager')">–ú–µ–Ω–µ–¥–∂–µ—Ä</button>
          <button onclick="setRole('courier')">–ö—É—Ä—å–µ—Ä</button>
        </div>
      </div>

      ${role==="manager" ? `<div id="orders"></div>` : ""}
      ${role==="courier" ? `<div id="orders"></div>` : ""}
    `;

    if(role==="manager") loadManager();
    if(role==="courier") loadCourier();
  }
}

/* ROLE */
function toggleRole(){
  const r=document.getElementById("roles");
  r.style.display=r.style.display==="block"?"none":"block";
}

function setRole(r){
  role=r;
  localStorage.setItem("role",r);
  render("profile");
}

/* CLIENT */
async function createOrder(){
  await fetch(`${SUPABASE_URL}/rest/v1/orders`,{
    method:"POST",
    headers:{
      apikey:SUPABASE_KEY,
      Authorization:`Bearer ${SUPABASE_KEY}`,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({
      telegram_id:user.id,
      status:"new"
    })
  });
  alert("–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω");
}

/* MANAGER */
async function loadManager(){
  const res=await fetch(`${SUPABASE_URL}/rest/v1/orders`,{
    headers:{apikey:SUPABASE_KEY,Authorization:`Bearer ${SUPABASE_KEY}`}
  });
  const orders=await res.json();
  document.getElementById("orders").innerHTML=orders.map(o=>`
    <div class="card">
      <b>–ó–∞–∫–∞–∑ ${o.id}</b>
      <select onchange="updateStatus('${o.id}',this.value)">
        <option ${o.status==="new"?"selected":""}>new</option>
        <option ${o.status==="cooking"?"selected":""}>cooking</option>
        <option ${o.status==="ready"?"selected":""}>ready</option>
        <option ${o.status==="courier"?"selected":""}>courier</option>
      </select>
    </div>
  `).join("");
}

async function updateStatus(id,status){
  await fetch(`${SUPABASE_URL}/rest/v1/orders?id=eq.${id}`,{
    method:"PATCH",
    headers:{
      apikey:SUPABASE_KEY,
      Authorization:`Bearer ${SUPABASE_KEY}`,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({status})
  });
}

/* COURIER */
async function loadCourier(){
  const res=await fetch(`${SUPABASE_URL}/rest/v1/orders?status=eq.courier`,{
    headers:{apikey:SUPABASE_KEY,Authorization:`Bearer ${SUPABASE_KEY}`}
  });
  const orders=await res.json();
  document.getElementById("orders").innerHTML=orders.map(o=>`
    <div class="card">
      –ó–∞–∫–∞–∑ ${o.id}
      <button onclick="completeOrder('${o.id}')">–°–¥–∞—Ç—å –∑–∞–∫–∞–∑</button>
    </div>
  `).join("");
}

async function completeOrder(id){
  await fetch(`${SUPABASE_URL}/rest/v1/orders?id=eq.${id}`,{
    method:"DELETE",
    headers:{apikey:SUPABASE_KEY,Authorization:`Bearer ${SUPABASE_KEY}`}
  });
  loadCourier();
}

render("home");
</script>

</body>
</html>
