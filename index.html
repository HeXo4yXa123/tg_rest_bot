<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Restaurant Mini App</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
:root {
  --bg-main: #0A0A09;
  --bg-surface: #191917;
  --accent: #21EA7C;
  --text-main: #FFFFFF;
  --text-muted: #777777;
}

* { box-sizing: border-box; }

body {
  margin: 0;
  padding: 16px;
  padding-bottom: 90px;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg-main);
  color: var(--text-main);
}

/* HEADER */
.header {
  display: flex;
  justify-content: flex-end;
  margin-bottom: 16px;
}

/* CONTENT */
#content {
  min-height: 60vh;
  animation: fadeIn 0.25s ease;
}

.fade-out {
  opacity: 0;
  transform: translateY(10px);
}

.card {
  background: var(--bg-surface);
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 12px;
}

button {
  background: var(--accent);
  color: #000;
  border: none;
  border-radius: 14px;
  padding: 12px;
  width: 100%;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
}

button.secondary {
  background: #2a2a2a;
  color: var(--text-main);
  margin-top: 8px;
}

/* BOTTOM NAV */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 72px;
  background: var(--bg-surface);
  display: flex;
  justify-content: space-around;
  align-items: center;
  border-top: 1px solid #222;
}

.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  font-size: 11px;
  color: var(--text-muted);
  cursor: pointer;
}

.nav-item.active { color: var(--accent); }

.nav-icon { font-size: 20px; }

/* ANIMATIONS */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>
</head>

<body>

<div class="header"></div>

<div id="content"></div>

<!-- BOTTOM NAV -->
<div class="bottom-nav">
  <div class="nav-item active" data-tab="home">
    <div class="nav-icon">üè†</div>
    <span>–ì–ª–∞–≤–Ω–∞—è</span>
  </div>
  <div class="nav-item" data-tab="favorites">
    <div class="nav-icon">‚≠ê</div>
    <span>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</span>
  </div>
  <div class="nav-item" data-tab="cart">
    <div class="nav-icon">üõí</div>
    <span>–ö–æ—Ä–∑–∏–Ω–∞</span>
  </div>
  <div class="nav-item" data-tab="profile">
    <div class="nav-icon">üë§</div>
    <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
  </div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.ready();

/* üîß SUPABASE */
const SUPABASE_URL = "https://urpxgkdzvzvxvykhusxo.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVycHhna2R6dnp2eHZ5a2h1c3hvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NTM1MjgsImV4cCI6MjA4MTIyOTUyOH0.i5qMCpsWx6E6YbxCEUZ8r0L90MHshJoMsOe55JZsAE0";

/* STATE */
let currentTab = "home";
let currentRole = "client";

const content = document.getElementById("content");
const navItems = document.querySelectorAll(".nav-item");

/* NAVIGATION */
navItems.forEach(item => {
  item.onclick = () => {
    navItems.forEach(i => i.classList.remove("active"));
    item.classList.add("active");
    switchTab(item.dataset.tab);
  };
});

function switchTab(tab) {
  content.classList.add("fade-out");
  setTimeout(() => {
    renderTab(tab);
    content.classList.remove("fade-out");
  }, 150);
}

function renderTab(tab) {
  currentTab = tab;

  if (tab === "home") {
    content.innerHTML = `
      <div class="card">
        <h3>–ì–ª–∞–≤–Ω–∞—è</h3>
        <p>–†–æ–ª—å: <b>${currentRole}</b></p>
      </div>
    `;
  }

  if (tab === "favorites") {
    content.innerHTML = `
      <div class="card">
        <h3>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</h3>
        <p>–ü–æ–∫–∞ –ø—É—Å—Ç–æ</p>
      </div>
    `;
  }

  if (tab === "cart") {
    content.innerHTML = `
      <div class="card">
        <h3>–ö–æ—Ä–∑–∏–Ω–∞</h3>
        <button onclick="createOrder()">–°–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑</button>
      </div>
    `;
  }

  if (tab === "profile") {
    content.innerHTML = `
      <div class="card">
        <h3>–ü—Ä–æ—Ñ–∏–ª—å</h3>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å:</p>
        <button class="secondary" onclick="setRole('client')">–Ø –∫–ª–∏–µ–Ω—Ç</button>
        <button class="secondary" onclick="setRole('manager')">–Ø –º–µ–Ω–µ–¥–∂–µ—Ä</button>
        <button class="secondary" onclick="setRole('courier')">–Ø –∫—É—Ä—å–µ—Ä</button>
      </div>
    `;
  }
}

/* ROLE */
function setRole(role) {
  currentRole = role;
  alert("–†–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞: " + role);
  renderTab(currentTab);
}

/* ORDER */
async function createOrder() {
  try {
    const telegramId = tg.initDataUnsafe.user.id;

    const userRes = await fetch(
      `${SUPABASE_URL}/rest/v1/users?telegram_id=eq.${telegramId}`,
      { headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` } }
    );
    const users = await userRes.json();
    if (!users.length) return alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω");

    const user = users[0];

    await fetch(`${SUPABASE_URL}/rest/v1/orders`, {
      method: "POST",
      headers: {
        apikey: SUPABASE_KEY,
        Authorization: `Bearer ${SUPABASE_KEY}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        user_id: user.id,
        branch_id: user.branch_id,
        status: "new",
        total_price: 500
      })
    });

    alert("–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω");
  } catch (e) {
    alert("–û—à–∏–±–∫–∞");
  }
}

/* INIT */
renderTab("home");
</script>

</body>
</html>
