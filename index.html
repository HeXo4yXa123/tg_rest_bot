<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Mini App MVP ‚Äì –ñ–∏–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
/* –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ–Ω –∏ —à—Ä–∏—Ñ—Ç—ã */
body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #0f0f0f; color: #eee; }
h2 { color: #00ff88; margin-bottom: 20px; text-shadow: 0 0 5px #00ff88; }

/* –ö–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏ */
#roleBtn {
  background: linear-gradient(135deg, #00ff88, #00cc88);
  color: #000;
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 14px 20px;
  border-radius: 20px;
  border: none;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 4px 8px rgba(0,255,136,0.4);
  transition: all 0.2s ease;
}
#roleBtn:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,255,136,0.5); }
#roleMenu {
  display:none;
  position:absolute;
  background:#1a1a1a;
  padding:10px;
  border-radius:16px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.6);
}
#roleMenu button {
  width:100%;
  margin-bottom:5px;
  padding: 10px;
  border-radius: 12px;
  border:none;
  font-weight:bold;
  background: #222;
  color: #00ff88;
  cursor: pointer;
  transition: all 0.2s;
}
#roleMenu button:hover { background: #00ff88; color:#000; transform: translateX(4px); }

/* –û–±—â–∏–µ –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
button.client { background: linear-gradient(135deg,#00ff88,#00cc88); color:#000; box-shadow: 0 4px 8px rgba(0,255,136,0.4);}
button.manager { background: linear-gradient(135deg,#ffcc00,#ffaa00); color:#000; box-shadow: 0 4px 8px rgba(255,204,0,0.4);}
button.courier { background: linear-gradient(135deg,#00ccff,#0099ff); color:#000; box-shadow: 0 4px 8px rgba(0,204,255,0.4);}
button:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(255,255,255,0.3); }

/* –ö–∞—Ä—Ç–æ—á–∫–∏ –∑–∞–∫–∞–∑–æ–≤ */
.orderCard {
  background: linear-gradient(135deg,#111,#1a1a1a);
  padding: 15px;
  border-radius: 16px;
  margin-bottom: 12px;
  box-shadow: 0 4px 12px rgba(0,255,136,0.3);
  transition: transform 0.2s, box-shadow 0.2s;
}
.orderCard:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(0,255,136,0.5); }

/* –õ–æ–≥ –¥–µ–π—Å—Ç–≤–∏–π */
#log {
  background: #222;
  padding: 12px;
  margin-top: 20px;
  border-radius: 16px;
  white-space: pre-wrap;
  box-shadow: 0 4px 8px rgba(0,255,136,0.2);
}

/* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –±–ª–æ–∫–∞ */
#iface-container { display:flex; flex-direction:column; gap:12px; }

</style>
</head>
<body>

<h2>Mini App: –∫–ª–∏–µ–Ω—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä-–∫—É—Ä—å–µ—Ä</h2>

<!-- –ö–Ω–æ–ø–∫–∞ —Å —á–µ–ª–æ–≤–µ—á–∫–æ–º -->
<button id="roleBtn">üë§ –í—ã–±—Ä–∞—Ç—å —Ä–æ–ª—å</button>

<!-- –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏ -->
<div id="roleMenu">
  <button data-role="client">–Ø –∫–ª–∏–µ–Ω—Ç</button>
  <button data-role="manager">–Ø –º–µ–Ω–µ–¥–∂–µ—Ä</button>
  <button data-role="courier">–Ø –∫—É—Ä—å–µ—Ä</button>
</div>

<div id="interface"></div>
<div id="log">–õ–æ–≥ –¥–µ–π—Å—Ç–≤–∏–π</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const tg = window.Telegram.WebApp;
  tg.ready();

  const SUPABASE_URL = "https://urpxgkdzvzvxvykhusxo.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVycHhna2R6dnp2eHZ5a2h1c3hvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NTM1MjgsImV4cCI6MjA4MTIyOTUyOH0.i5qMCpsWx6E6YbxCEUZ8r0L90MHshJoMsOe55JZsAE0";

  const roleBtn = document.getElementById("roleBtn");
  const roleMenu = document.getElementById("roleMenu");
  const iface = document.getElementById("interface");
  const log = document.getElementById("log");

  let currentRole = "client";

  // –ü–æ–∫–∞–∑ / —Å–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏
  roleBtn.onclick = (e) => {
    roleMenu.style.display = roleMenu.style.display === "block" ? "none" : "block";
    roleMenu.style.top = e.target.offsetTop + e.target.offsetHeight + "px";
    roleMenu.style.left = e.target.offsetLeft + "px";
  };

  // –í—ã–±–æ—Ä —Ä–æ–ª–∏
  roleMenu.querySelectorAll("button").forEach(btn => {
    btn.onclick = () => {
      currentRole = btn.dataset.role;
      roleMenu.style.display = "none";
      log.textContent = `–í—ã –≤—ã–±—Ä–∞–ª–∏ —Ä–æ–ª—å: ${currentRole}`;
      renderInterface();
    };
  });

  async function fetchOrders(filter="") {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/orders?${filter}&order=created_at.asc`, {
      headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` }
    });
    return await res.json();
  }

  async function renderInterface() {
    iface.innerHTML = "";

    if (currentRole === "client") {
      const btn = document.createElement("button");
      btn.textContent = "–°–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑";
      btn.className = "client";
      btn.onclick = async () => {
        try {
          const telegramId = tg.initDataUnsafe.user.id;
          const userRes = await fetch(`${SUPABASE_URL}/rest/v1/users?telegram_id=eq.${telegramId}`, {
            headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` }
          });
          const users = await userRes.json();
          if (!users.length) { log.textContent = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω"; return; }
          const user = users[0];

          const orderRes = await fetch(`${SUPABASE_URL}/rest/v1/orders`, {
            method: "POST",
            headers: { 
              apikey: SUPABASE_KEY,
              Authorization: `Bearer ${SUPABASE_KEY}`,
              "Content-Type": "application/json",
              Prefer: "return=representation"
            },
            body: JSON.stringify({ user_id: user.id, branch_id: user.branch_id, status:"new", total_price:500 })
          });
          const order = await orderRes.json();
          log.textContent = `–ö–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–ª –∑–∞–∫–∞–∑: ${order[0].id}`;
        } catch(e) { log.textContent = "–û—à–∏–±–∫–∞: " + e; }
      };
      iface.appendChild(btn);

    } else if (currentRole === "manager") {
      try {
        const orders = await fetchOrders();
        if (!orders.length) { iface.textContent = "–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤"; return; }

        orders.forEach(order => {
          const div = document.createElement("div");
          div.className = "orderCard";
          div.textContent = `–ó–∞–∫–∞–∑ ${order.id} | –°—Ç–∞—Ç—É—Å: ${order.status}`;

          const statuses = ["new", "accepted", "cooking", "ready", "delivering"];
          statuses.forEach(s => {
            const btnStatus = document.createElement("button");
            btnStatus.textContent = s;
            btnStatus.className = "manager";
            btnStatus.onclick = async () => {
              await fetch(`${SUPABASE_URL}/rest/v1/orders?id=eq.${order.id}`, {
                method: "PATCH",
                headers:{apikey:SUPABASE_KEY, Authorization:`Bearer ${SUPABASE_KEY}`, "Content-Type":"application/json"},
                body: JSON.stringify({status:s})
              });
              log.textContent = `–ú–µ–Ω–µ–¥–∂–µ—Ä –∏–∑–º–µ–Ω–∏–ª –∑–∞–∫–∞–∑ ${order.id} –Ω–∞ —Å—Ç–∞—Ç—É—Å ${s}`;
              renderInterface();
            };
            div.appendChild(btnStatus);
          });

          const btnCourier = document.createElement("button");
          btnCourier.textContent = "–ü–µ—Ä–µ–¥–∞—Ç—å –∫—É—Ä—å–µ—Ä—É";
          btnCourier.className = "manager";
          btnCourier.onclick = async () => {
            await fetch(`${SUPABASE_URL}/rest/v1/orders?id=eq.${order.id}`, {
              method: "PATCH",
              headers:{apikey:SUPABASE_KEY, Authorization:`Bearer ${SUPABASE_KEY}`, "Content-Type":"application/json"},
              body: JSON.stringify({status:"accepted"})
            });
            log.textContent = `–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–µ—Ä–µ–¥–∞–ª –∑–∞–∫–∞–∑ ${order.id} –∫—É—Ä—å–µ—Ä—É`;
            renderInterface();
          };
          div.appendChild(btnCourier);

          iface.appendChild(div);
        });
      } catch(e){ log.textContent = "–û—à–∏–±–∫–∞: " + e; }

    } else if (currentRole === "courier") {
      try {
        const orders = await fetchOrders("status=eq.accepted");
        if (!orders.length) { iface.textContent = "–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏"; return; }

        orders.forEach(order => {
          const div = document.createElement("div");
          div.className = "orderCard";
          div.textContent = `–ó–∞–∫–∞–∑ ${order.id} | –°—Ç–∞—Ç—É—Å: ${order.status}`;
          const btnPick = document.createElement("button");
          btnPick.textContent = "–í–∑—è—Ç—å –∏ –¥–æ—Å—Ç–∞–≤–∏—Ç—å";
          btnPick.className = "courier";
          btnPick.onclick = async () => {
            await fetch(`${SUPABASE_URL}/rest/v1/orders?id=eq.${order.id}`, {
              method:"PATCH",
              headers:{apikey:SUPABASE_KEY, Authorization:`Bearer ${SUPABASE_KEY}`, "Content-Type":"application/json"},
              body: JSON.stringify({status:"delivered"})
            });
            log.textContent = `–ö—É—Ä—å–µ—Ä –¥–æ—Å—Ç–∞–≤–∏–ª –∑–∞–∫–∞–∑ ${order.id}`;
            renderInterface();
          };
          div.appendChild(btnPick);
          iface.appendChild(div);
        });
      } catch(e){ log.textContent = "–û—à–∏–±–∫–∞: " + e; }
    }
  }

  renderInterface();
});
</script>

</body>
</html>
