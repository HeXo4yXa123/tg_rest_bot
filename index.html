<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Restaurant Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>

<h2>üçî –°–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑</h2>
<button id="create">–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</button>

<pre id="log"></pre>

<script>
const tg = window.Telegram.WebApp;
tg.ready();

// 1. –ø–æ–ª—É—á–∞–µ–º telegram_id
const telegramId = tg.initDataUnsafe?.user?.id;

document.getElementById("log").textContent =
  "telegram_id: " + telegramId;

// 2. Supabase –¥–∞–Ω–Ω—ã–µ
const SUPABASE_URL = "https://urpxgkdzvzvxvykhusxo.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVycHhna2R6dnp2eHZ5a2h1c3hvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NTM1MjgsImV4cCI6MjA4MTIyOTUyOH0.i5qMCpsWx6E6YbxCEUZ8r0L90MHshJoMsOe55JZsAE0";

// 3. –∫–Ω–æ–ø–∫–∞ –∑–∞–∫–∞–∑–∞
document.getElementById("create").onclick = async () => {
  try {
    // --- –∏—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---
    const userRes = await fetch(
      `${SUPABASE_URL}/rest/v1/users?telegram_id=eq.${telegramId}`,
      {
        headers: {
          "apikey": SUPABASE_KEY,
          "Authorization": `Bearer ${SUPABASE_KEY}`
        }
      }
    );

    const users = await userRes.json();
    if (!users.length) {
      throw "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω";
    }

    const user = users[0];

    // --- —Å–æ–∑–¥–∞—ë–º –∑–∞–∫–∞–∑ ---
    const orderRes = await fetch(
      `${SUPABASE_URL}/rest/v1/orders`,
      {
        method: "POST",
        headers: {
          "apikey": SUPABASE_KEY,
          "Authorization": `Bearer ${SUPABASE_KEY}`,
          "Content-Type": "application/json",
          "Prefer": "return=representation"
        },
        body: JSON.stringify({
          user_id: user.id,
          branch_id: user.branch_id,
          status: "new",
          total_price: 500
        })
      }
    );

    const order = await orderRes.json();
const orderId = order[0].id;

// —á–∏—Ç–∞–µ–º –∑–∞–∫–∞–∑
const statusRes = await fetch(
  `${SUPABASE_URL}/rest/v1/orders?id=eq.${orderId}`,
  {
    headers: {
      "apikey": SUPABASE_KEY,
      "Authorization": `Bearer ${SUPABASE_KEY}`
    }
  }
);

const statusData = await statusRes.json();

document.getElementById("log").textContent =
  "–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞: " + statusData[0].status;

</script>

</body>
</html>
