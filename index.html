<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Mini App MVP</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
body { font-family: sans-serif; padding: 20px; background: #111; color: #eee; }
h2 { color: #00ff88; }
button { padding: 10px 20px; margin: 5px; border: none; border-radius: 8px; cursor: pointer; }
.client { background: #00ff88; color: #000; }
.manager { background: #ffcc00; color: #000; }
.courier { background: #00ccff; color: #000; }
#log { background: #222; padding: 10px; margin-top: 10px; border-radius: 8px; white-space: pre-wrap; }
</style>
</head>
<body>

<h2>Mini App MVP: –∫–ª–∏–µ–Ω—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä-–∫—É—Ä—å–µ—Ä</h2>

<div>
<label>–í—ã–±—Ä–∞—Ç—å —Ä–æ–ª—å: </label>
<select id="roleSelect">
  <option value="client">–ö–ª–∏–µ–Ω—Ç</option>
  <option value="manager">–ú–µ–Ω–µ–¥–∂–µ—Ä</option>
  <option value="courier">–ö—É—Ä—å–µ—Ä</option>
</select>
</div>

<div id="interface" style="margin-top:20px;"></div>
<div id="log"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const tg = window.Telegram.WebApp;
  tg.ready();

  // üîß –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ó–ê–ú–ï–ù–ò
  const SUPABASE_URL = "https://urpxgkdzvzvxvykhusxo.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVycHhna2R6dnp2eHZ5a2h1c3hvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NTM1MjgsImV4cCI6MjA4MTIyOTUyOH0.i5qMCpsWx6E6YbxCEUZ8r0L90MHshJoMsOe55JZsAE0";

  const roleSelect = document.getElementById("roleSelect");
  const iface = document.getElementById("interface");
  const log = document.getElementById("log");

  let currentRole = roleSelect.value;
  roleSelect.onchange = () => { currentRole = roleSelect.value; renderInterface(); };

  async function fetchOrders(filter="") {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/orders?${filter}&order=created_at.asc`, {
      headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` }
    });
    return await res.json();
  }

  async function renderInterface() {
    iface.innerHTML = "";

    if (currentRole === "client") {
      const btn = document.createElement("button");
      btn.textContent = "–°–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑";
      btn.className = "client";
      btn.onclick = async () => {
        try {
          const telegramId = tg.initDataUnsafe.user.id;
          const userRes = await fetch(`${SUPABASE_URL}/rest/v1/users?telegram_id=eq.${telegramId}`, {
            headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` }
          });
          const users = await userRes.json();
          if (!users.length) { log.textContent = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω"; return; }
          const user = users[0];

          const orderRes = await fetch(`${SUPABASE_URL}/rest/v1/orders`, {
            method: "POST",
            headers: { 
              apikey: SUPABASE_KEY,
              Authorization: `Bearer ${SUPABASE_KEY}`,
              "Content-Type": "application/json",
              Prefer: "return=representation"
            },
            body: JSON.stringify({ user_id: user.id, branch_id: user.branch_id, status:"new", total_price:500 })
          });
          const order = await orderRes.json();
          log.textContent = `–ö–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–ª –∑–∞–∫–∞–∑: ${order[0].id}`;
        } catch(e) { log.textContent = "–û—à–∏–±–∫–∞: " + e; }
      };
      iface.appendChild(btn);

    } else if (currentRole === "manager") {
      try {
        const orders = await fetchOrders();
        if (!orders.length) { iface.textContent = "–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤"; return; }

        orders.forEach(order => {
          const div = document.createElement("div");
          div.style.marginBottom = "10px";
          div.textContent = `–ó–∞–∫–∞–∑ ${order.id} | –°—Ç–∞—Ç—É—Å: ${order.status}`;

          const statuses = ["new", "accepted", "cooking", "ready", "delivering", "delivered"];
          statuses.forEach(s => {
            const btnStatus = document.createElement("button");
            btnStatus.textContent = s;
            btnStatus.className = "manager";
            btnStatus.onclick = async () => {
              await fetch(`${SUPABASE_URL}/rest/v1/orders?id=eq.${order.id}`, {
                method: "PATCH",
                headers:{apikey:SUPABASE_KEY, Authorization:`Bearer ${SUPABASE_KEY}`, "Content-Type":"application/json"},
                body: JSON.stringify({status:s})
              });
              log.textContent = `–ú–µ–Ω–µ–¥–∂–µ—Ä –∏–∑–º–µ–Ω–∏–ª –∑–∞–∫–∞–∑ ${order.id} –Ω–∞ —Å—Ç–∞—Ç—É—Å ${s}`;
              renderInterface();
            };
            div.appendChild(btnStatus);
          });
          iface.appendChild(div);
        });
      } catch(e){ log.textContent = "–û—à–∏–±–∫–∞: " + e; }

    } else if (currentRole === "courier") {
      try {
        const orders = await fetchOrders("status=eq.accepted");
        if (!orders.length) { iface.textContent = "–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏"; return; }

        orders.forEach(order => {
          const div = document.createElement("div");
          div.style.marginBottom = "10px";
          div.textContent = `–ó–∞–∫–∞–∑ ${order.id} | –°—Ç–∞—Ç—É—Å: ${order.status}`;
          const btnPick = document.createElement("button");
          btnPick.textContent = "–í–∑—è—Ç—å –∏ –¥–æ—Å—Ç–∞–≤–∏—Ç—å";
          btnPick.className = "courier";
          btnPick.onclick = async () => {
            await fetch(`${SUPABASE_URL}/rest/v1/orders?id=eq.${order.id}`, {
              method:"PATCH",
              headers:{apikey:SUPABASE_KEY, Authorization:`Bearer ${SUPABASE_KEY}`, "Content-Type":"application/json"},
              body: JSON.stringify({status:"delivered"})
            });
            log.textContent = `–ö—É—Ä—å–µ—Ä –¥–æ—Å—Ç–∞–≤–∏–ª –∑–∞–∫–∞–∑ ${order.id}`;
            renderInterface();
          };
          div.appendChild(btnPick);
          iface.appendChild(div);
        });
      } catch(e){ log.textContent = "–û—à–∏–±–∫–∞: " + e; }
    }
  }

  renderInterface();
});
</script>

</body>
</html>
