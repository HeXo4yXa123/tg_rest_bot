<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Food Mini App</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
:root{
  --bg:#0A0A09;
  --card:#191917;
  --accent:#21EA7C;
  --text:#fff;
  --muted:#8a8a8a;
}

*{box-sizing:border-box}

body{
  margin:0;
  padding:16px;
  padding-bottom:120px;
  background:var(--bg);
  font-family:system-ui;
  color:var(--text);
}

h1{margin:12px 0}

.card{
  background:var(--card);
  border-radius:18px;
  padding:16px;
  margin-bottom:12px;
}

button{
  width:100%;
  padding:14px;
  border:none;
  border-radius:16px;
  font-weight:600;
  background:var(--accent);
  color:#000;
}

.secondary{
  background:#2a2a2a;
  color:#fff;
  margin-top:8px;
}

.muted{color:var(--muted)}

.bottom-nav{
  position:fixed;
  bottom:12px;
  left:12px;
  right:12px;
  background:var(--card);
  border-radius:26px;
  padding:10px;
  display:flex;
}

.nav-item{
  flex:1;
  text-align:center;
  font-size:11px;
  color:var(--muted);
}

.nav-item.active{color:var(--accent)}
</style>
</head>

<body>

<div id="content"></div>

<div class="bottom-nav">
  <div class="nav-item active" data-tab="home">üè†<br><span data-t="home">–ì–ª–∞–≤–Ω–∞—è</span></div>
  <div class="nav-item" data-tab="cart">üõí<br><span data-t="cart">–ö–æ—Ä–∑–∏–Ω–∞</span></div>
  <div class="nav-item" data-tab="profile">üë§<br><span data-t="profile">–ü—Ä–æ—Ñ–∏–ª—å</span></div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.ready();

/* SUPABASE */
const SUPABASE_URL="https://urpxgkdzvzvxvykhusxo.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVycHhna2R6dnp2eHZ5a2h1c3hvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NTM1MjgsImV4cCI6MjA4MTIyOTUyOH0.i5qMCpsWx6E6YbxCEUZ8r0L90MHshJoMsOe55JZsAE0";

/* STATE */
let role=localStorage.getItem("role")||"client";
let lang=localStorage.getItem("lang")||"ru";
const tgUser=tg.initDataUnsafe?.user;

/* TRANSLATIONS */
const t={
  ru:{
    home:"–ì–ª–∞–≤–Ω–∞—è",
    cart:"–ö–æ—Ä–∑–∏–Ω–∞",
    profile:"–ü—Ä–æ—Ñ–∏–ª—å",
    order:"–°–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑",
    empty:"–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞",
    language:"–Ø–∑—ã–∫"
  },
  en:{
    home:"Home",
    cart:"Cart",
    profile:"Profile",
    order:"Make order",
    empty:"Cart is empty",
    language:"Language"
  }
};

const restaurants=[
  "BBQ Garden",
  "Cafe LaiLa",
  "Cafe Ushba",
  "–î–æ–º –ö—É–¥–±–∞—Ä–∏",
  "Sunset Restaurant"
];

const content=document.getElementById("content");
const nav=document.querySelectorAll(".nav-item");

/* INIT USER */
async function initUser(){
  if(!tgUser) return;
  await fetch(`${SUPABASE_URL}/rest/v1/users`,{
    method:"POST",
    headers:{
      apikey:SUPABASE_KEY,
      Authorization:`Bearer ${SUPABASE_KEY}`,
      "Content-Type":"application/json",
      Prefer:"resolution=ignore-duplicates"
    },
    body:JSON.stringify({
      telegram_id:tgUser.id,
      role,
      language:lang
    })
  });
}

/* NAV */
nav.forEach(i=>{
  i.onclick=()=>{
    nav.forEach(n=>n.classList.remove("active"));
    i.classList.add("active");
    render(i.dataset.tab);
  };
});

function translate(){
  document.querySelectorAll("[data-t]").forEach(el=>{
    el.innerText=t[lang][el.dataset.t];
  });
}

function render(tab){
  translate();

  if(tab==="home"){
    content.innerHTML=`<h1>${t[lang].home}</h1>`+
      restaurants.map(r=>`
        <div class="card">
          <b>${r}</b>
          <button class="secondary">Open</button>
        </div>
      `).join("");
  }

  if(tab==="cart"){
    content.innerHTML=`
      <div class="card">
        <p>${t[lang].empty}</p>
        <button onclick="createOrder()">${t[lang].order}</button>
      </div>`;
  }

  if(tab==="profile"){
    content.innerHTML=`
      <div class="card">
        <b>${tgUser?.first_name||"User"}</b><br>
        <span class="muted">ID ${tgUser?.id}</span>
      </div>

      <div class="card">
        <p>${t[lang].language}</p>
        <button class="secondary" onclick="setLang('ru')">–†—É—Å—Å–∫–∏–π</button>
        <button class="secondary" onclick="setLang('en')">English</button>
      </div>`;
  }
}

function setLang(l){
  lang=l;
  localStorage.setItem("lang",l);
  render("profile");
}

/* ORDER */
async function createOrder(){
  await fetch(`${SUPABASE_URL}/rest/v1/orders`,{
    method:"POST",
    headers:{
      apikey:SUPABASE_KEY,
      Authorization:`Bearer ${SUPABASE_KEY}`,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({
      status:"new",
      telegram_id:tgUser.id
    })
  });
  alert("Order created");
}

/* INIT */
initUser();
render("home");
</script>

</body>
</html>
